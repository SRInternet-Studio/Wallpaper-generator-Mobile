name: ğŸš€ å‘å¸ƒ Tauri åº”ç”¨

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  release:
    types: [published] # å½“æ–°çš„ Release å‘å¸ƒæ—¶è§¦å‘

jobs:
  build-android:
    name: ğŸ¤– æ„å»ºå®‰å“åº”ç”¨
    permissions:
      contents: write # éœ€è¦å†™å…¥æƒé™ä»¥ä¸Šä¼  Release
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ° è®¾ç½® Bun ç¯å¢ƒ
        uses: oven-sh/setup-bun@v1

      - name: ğŸ—„ï¸ ç¼“å­˜ Bun ä¾èµ–
        id: cache-bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
        run: bun install

      - name: â˜• è®¾ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ğŸ“± è®¾ç½® Android SDK
        uses: android-actions/setup-android@v3

      - name: ğŸ—„ï¸ ç¼“å­˜ Gradle å’Œ NDK
        id: cache-android
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ${{ env.ANDROID_HOME }}/ndk/27.0.11902837
          key: ${{ runner.os }}-gradle-ndk-${{ hashFiles('**/build.gradle.kts', '**/gradle.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-ndk-

      - name: â¬‡ï¸ å®‰è£… NDK (å¦‚æœç¼“å­˜æœªå‘½ä¸­)
        if: steps.cache-android.outputs.cache-hit != 'true'
        run: sdkmanager "ndk;27.0.11902837"

      - name: ğŸ¦€ å®‰è£… Rust stable å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: ğŸ—„ï¸ ç¼“å­˜ Rust ä¾èµ– (Cargo)
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: ğŸ‘· æ„å»ºå®‰å“ APK
        id: build_apk
        env:
          NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/27.0.11902837
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          # ä» package.json è·å–åº”ç”¨ç‰ˆæœ¬å·
          APP_VERSION=$(bun -e "console.log(require('./package.json').version)")
          
          # å®šä¹‰ APK æ–‡ä»¶åå¹¶å°†å…¶è®¾ç½®ä¸ºæ­¥éª¤çš„è¾“å‡º
          ARM64_APK_NAME="tauri-app_${APP_VERSION}_arm64-v8a.apk"
          echo "apk_name=${ARM64_APK_NAME}" >> $GITHUB_OUTPUT
          
          # å¦‚æœæä¾›äº†å®‰å“ç­¾åå¯†é’¥ï¼Œåˆ™è®¾ç½®ç­¾å
          SIGNED_SUFFIX="-unsigned"
          if [ -n "${{ secrets.ANDROID_KEY_BASE64 }}" ]; then
            echo "æ£€æµ‹åˆ°å®‰å“ç­¾åå¯†é’¥ï¼Œå¼€å§‹è¿›è¡Œç­¾åæ„å»ºã€‚"
            SIGNED_SUFFIX=""
            
            # åˆ›å»º keystore.properties æ–‡ä»¶
            echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" > src-tauri/gen/android/app/keystore.properties
            echo "password=${{ secrets.ANDROID_KEY_PASSWORD }}" >> src-tauri/gen/android/app/keystore.properties
            echo "storeFile=$RUNNER_TEMP/keystore.jks" >> src-tauri/gen/android/app/keystore.properties
            
            # è§£ç  Base64 å¯†é’¥å¹¶åˆ›å»º keystore æ–‡ä»¶
            base64 -d <<< "${{ secrets.ANDROID_KEY_BASE64 }}" > $RUNNER_TEMP/keystore.jks
          else
            echo "æœªæ£€æµ‹åˆ°å®‰å“ç­¾åå¯†é’¥ï¼Œå°†è¿›è¡Œæœªç­¾åæ„å»ºã€‚"
          fi
          
          # æ„å»º arm64 æ¶æ„çš„ APK
          bun run tauri android build -t aarch64
          # æ³¨æ„ï¼šæ— è®ºç›®æ ‡æ¶æ„å¦‚ä½•ï¼Œè¾“å‡ºè·¯å¾„æ€»æ˜¯ 'universal'
          SOURCE_APK="src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release${SIGNED_SUFFIX}.apk"
          mv "$SOURCE_APK" "$ARM64_APK_NAME"

      - name: ğŸš€ ä¸Šä¼ åˆ° Release (ä»…åœ¨å‘å¸ƒæ–°ç‰ˆæ—¶)
        if: github.event_name == 'release'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ github.event.release.tag_name }} ${{ steps.build_apk.outputs.apk_name }} --clobber

      - name: ğŸ“¤ ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰© (ä»…åœ¨æ‰‹åŠ¨è§¦å‘æ—¶)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ steps.build_apk.outputs.apk_name }}
